<?php
/**
 * @file
 * Main file for the message UI module.
 */

use Drupal\Core\Url;
use Drupal\user\Entity\User;
use Drupal\message\Entity\Message;
use Drupal\message\Entity\MessageType;
use Drupal\Core\Entity\Entity\EntityFormDisplay;

/**
 * Grant permission for the operation upon message.
 */
define('MESSAGE_UI_ALLOW', TRUE);

/**
 * Deny permission for the operation upon message.
 */
define('MESSAGE_UI_DENY', FALSE);

/**
 * Implements hook_queue_info().
 *
 * @todo: do I need to create a queue worker? https://www.drupal.org/node/2341649
 */
function message_ui_queue_info() {
  $items['message_ui_arguments'] = array(
    'title' => t('Message UI arguments'),
    'worker callback' => 'message_ui_arguments_worker',
    'time' => 60,
  );
  return $items;
}

/**
 * Implements hook_theme().
 */
// @todo: should this be moved to Twig template?
function message_ui_theme() {
  return array(
    'message_ui_create_message' => array(
      'variables' => array('items' => NULL),
    ),
  );
}

/**
 * Theme callback - display list of the message types in the proper way.
 */
// @todo: should this be moved to Twig template?
function theme_message_ui_create_message($variables) {
  $items = $variables['items'];

  $output = '<ul class="admin-list">';

  foreach ($items as $item) {
    $output .= '<li class="clearfix">';

    $url = Url::fromUri('admin/content/message/create/' . str_replace('_', '-', $item['type']));
    $internal_link = \Drupal::l(ucfirst(str_replace('_', ' ', $item['type'])), $url);

    $output .= '<span class="label">' . $internal_link;
    $output .= '<div class="description">' . t('Create a message instance of @type', array('@type' => $item['name'])) . '</div>';
    $output .= '</li>';
  }

  $output .= '</ul>';

  return $output;
}

/**
 * Get hard coded arguments.
 *
 * @param $type
 *  The message type.
 * @param $count
 *  Determine weather to the count the arguments or return a list of them.
 * @return int
 *  The number of the arguments.
 */
function message_ui_message_arguments($type, $count = FALSE) {
  /* @var $message_type MessageType */
  $message_type = MessageType::load($type);

  if (!$output = $message_type->getText()) {
    return FALSE;
  }

  preg_match_all('/[@|%|\!]\{([a-z0-9:_\-]+?)\}/i', $output, $matches);

  return $count ? count($matches[0]) : $matches[0];
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function message_ui_form_message_user_admin_settings_alter(&$form, $form_state) {
  $form['update_tokens'] = array(
    '#type' => 'fieldset',
    '#itle' => t('Token update settings'),
  );
  $form['update_tokens']['update_tokens_update_tokens'] = array(
    '#type' => 'checkbox',
    '#title' => t('Update messages arguments'),
    '#description' => t('When editing a message type, the user can add or delete arguments. When this is checked, you can choose how to update to messages arguments.'),
    '#default_value' => \Drupal::config('message_ui.settings')->get('update_tokens.update_tokens'),
  );

  $form['update_tokens']['update_tokens_how_to_act'] = array(
    '#type' => 'select',
    '#title' => t('Choose how to act'),
    '#default_value' => \Drupal::config('message_ui.settings')->get('update_tokens.how_to_act'),
    '#options' => array(
      'update_when_removed' => t('Update messages when tokens are removed'),
      'update_when_added' => t('Update messages when tokens are added'),
    ),
    '#states' => array(
      'visible' => array(
        ':input[name="update_tokens_update_tokens"]' => array('checked' => TRUE),
      ),
    ),
  );

  $form['update_tokens']['update_tokens_how_update'] = array(
    '#type' => 'select',
    '#title' => t('Choose how to update the messages'),
    '#default_value' => \Drupal::config('message_ui.settings')->get('update_tokens.how_update'),
    '#options' => array(
      'update_with_batch' => t('Update messages with batch API'),
      'update_when_item' => t('Update messages with queue item'),
    ),
    '#states' => array(
      'visible' => array(
        ':input[name="update_tokens_update_tokens"]' => array('checked' => TRUE),
      ),
    ),
  );

  $form['update_tokens']['update_tokens_number_items'] = array(
    '#type' => 'textfield',
    '#size' => '10',
    '#title' => t('Items to process each time.'),
    '#description' => t('Choose how much items to process each iteration.'),
    '#default_value' => \Drupal::config('message_ui.settings')->get('update_tokens.number_items'),
    '#states' => array(
      'visible' => array(
        ':input[name="update_tokens_update_tokens"]' => array('checked' => TRUE),
      ),
    ),
  );

  $form['message_ui_show_preview'] = array(
    '#type' => 'radios',
    '#title' => t('Show/hide preview'),
    '#default_value' => \Drupal::config('message_ui.settings')->get('show_preview'),
    '#options' =>  array(
      TRUE =>  t('Show preview'),
      FALSE => t('Hide preview'),
    ),
    '#description' => t('Show/hide the text of the message when editing an instance of the message.'),
  );
}

/**
 * Form submit handler for admin form message_user_admin_settings.
 *
 * Update message_ui configuration on form submit.
 *
 * @param $form
 * @param $form_state
 */
function message_ui_form_message_user_admin_settings_submit($form, &$form_state) {

  $config = \Drupal::configFactory()->getEditable('message_ui.settings');

  // @todo - step through & check if nested 'update_tokens' index is required.
  $config->set('update_tokens.update_tokens', $form_state['values']['update_tokens_update_tokens'] );

  $config->set('update_tokens.how_to_act', $form_state['values']['update_tokens_how_to_act'] );

  // @todo: Does how_update need a default setting explicitly set in yaml file?
  $config->set('update_tokens.how_update', $form_state['values']['update_tokens_how_update'] );

  $config->set('update_tokens.number_items', $form_state['values']['update_tokens_number_items'] );

  $config->set('show_preview', $form_state['values']['message_ui_show_preview'] );

  $config->save();
}

/**
 * Implements hook_entity_update().
 *
 * Submit handler for updating the arguments number.
 *
 * When a message type is been edited, there could be a change in the arguments
 * of the message - added or removed.
 * If this has been defined, we need to update the arguments of the other
 * messages. This will be achieved by in two steps:
 * 1. Load an instance of the message from the same type
 * 2. Cont the number of the arguments and if there is a difference between the
 *    number of the arguments from the old message to the current one - create
 *    a batch or a queue and update the messages.
 */
function message_ui_entity_update(Drupal\Core\Entity\EntityInterface $entity) {
  $type = $entity->getEntityType()->getLabel();

  if ($type != 'message_type') {
    return FALSE;
  }

  $query = \Drupal::entityQuery('message');
  $result = $query
    ->condition('type', $type)
    ->range(0, 1)
    ->sort('mid', 'DESC')
    ->execute();

  // There is no messages from this type.
  if (empty($result['message'])) {
    return FALSE;
  }

  $keys = array_keys($result['message']);
  $message = Message::load(reset($keys));
  $new_arguments = message_ui_message_arguments($type);

  $old_arguments_number = count($message->getArguments());
  $new_arguments_number = count($new_arguments);
  $how_to_act = \Drupal::config('message_ui.settings')->get('update_tokens.how_to_act');

  $update['when_added'] = $old_arguments_number < $new_arguments_number && $how_to_act == 'update_when_added';
  $update['when_removed'] = $old_arguments_number > $new_arguments_number && $how_to_act == 'update_when_removed';

  if (!($update['when_added'] || $update['when_removed'])) {
    return FALSE;
  }

  $item_to_process = \Drupal::config('message_ui.settings')->get('update_tokens.number_items');
  $how_update = \Drupal::config('message_ui.settings')->get('update_tokens.how_update');

  if ($how_update == 'update_with_batch') {

    // Get all the messages.
    $query = \Drupal::entityQuery('message');
    $result = $query
      ->condition('type', $type)
      ->sort('mid', 'DESC')
      ->execute();

    $chunks = array_chunk(array_keys($result['message']), $item_to_process);
    $operations = array();
    foreach ($chunks as $chunk) {
      $operations[] = array('message_ui_arguments_update', array($chunk, $new_arguments));
    }

    // Set the batch.
    $batch = array(
      'operations' => $operations,
      'finished' => 'message_ui_message_arguments_update',
      'title' => t('Updating the messages arguments.'),
      'init_message' => t('Start process messages.'),
      'progress_message' => t('Processed @current out of @total.'),
      'error_message' => t('Example Batch has encountered an error.'),
    );
    batch_set($batch);
    batch_process('admin/structure/messages');
  }
  elseif ($how_update == 'update_when_item') {
    // Define the queue item data.
    $data = array(
      'type' => $type,
      'last_mid' => 0,
      'new_arguments' => $new_arguments,
      'item_to_process' => $item_to_process,
    );

    // Set the queue worker.
    $queue = \Drupal::queue('message_ui_arguments');
    return $queue->createItem($data);
  }
}

/**
 * The message batch or queue item callback function.
 *
 * @param $mids
 *  The messages ID for process.
 * @param $arguments
 *  The new state arguments.
 */
function message_ui_arguments_update($mids, $arguments) {
  // Load the messages and update them.
  $messages = Message::loadMultiple($mids);

  foreach ($messages as $message) {
    _message_ui_arguments_update($message, $arguments);
  }
}

/**
 * Update the message arguments via a queue worker.
 */
function message_ui_arguments_worker($data) {

  // Load all of the messages.
  $query = \Drupal::entityQuery('message');
  $result = $query
    ->condition('type', $data['type'])
    ->sort('mid', 'DESC')
    ->condition('mid', $data['last_mid'], '>=')
    ->range(0, $data['item_to_process'])
    ->execute();

  if (empty($result['message'])) {
    return FALSE;
  }
  
  // Update the messages.
  $messages = Message::loadMultiple(array_keys($result['message']));
  foreach ($messages as $message) {
    _message_ui_arguments_update($message, $data['new_arguments']);
    $data['last_mid'] = $message->id();
  }

  // Create the next queue worker.
  $queue = \Drupal::queue('message_ui_arguments');
  return $queue->createItem($data);
}

/**
 * A helper function for generate a new array of the message's arguments.
 *
 * @param Message $message
 *  The message which her arguments need an update.
 * @param array $arguments
 *  The new arguments need to be calculated.
 */
function _message_ui_arguments_update(Message $message, $arguments) {

  $message_arguments = array();

  foreach ($arguments as $token) {
    // Get the hard coded value of the message and him in the message.
    $token_name = str_replace(array('@{', '}'), array('[', ']'), $token);
    $token_service = Drupal::token();
    $value = $token_service->replace($token_name, array('message' => $message));

    $message_arguments[$token] = $value;
  }

  $message->getArguments() = $message_arguments;
  $message->save();
}
